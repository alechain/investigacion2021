---
title: "Macrolocalizacion de regiones con K-means"
header-includes:
  - \usepackage[spanish]{babel}
output: 
  pdf_document:
    toc: true
---
```{r echo = FALSE, warning=FALSE, error=FALSE, message=FALSE, include=FALSE}
setwd("/home/alejandrochain/Documentos/GitHub/investigacion2021/macrolocalizacion")
knitr::opts_chunk$set(echo = FALSE, dev="cairo_pdf")
library(readr)
library(tidyverse)
library(factoextra)
library(cluster)
library(fpc)
#estos sirven para formatear pa latex
library(stargazer)
library(xtable)
library(extrafont)
library(eph)
library(readxl)
library(sf)
library(tmap)
library(tmaptools)

color<- c('#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33','#a65628','#f781bf')
```

```{r}
## Individual
ephi<- get_microdata(year=2017:2019, trimester = 1:4, type = "individual")
ephi<- ephi %>%
dplyr::select(microdata) %>%
tidyr::unnest(cols = c(microdata))
### 2016 
ephi2<- get_microdata(year=2016, trimester = 2:4, type = "individual")
ephi2<- ephi2 %>%
dplyr::select(microdata) %>%
tidyr::unnest(cols = c(microdata))

ephi<- bind_rows(ephi,ephi2)
ephi<- ephi %>% arrange(-ANO4, -TRIMESTRE)

## Hogar
ephh<- get_microdata(year=2017:2019, trimester = 1:4, type = "hogar")
ephh<- ephh %>%
dplyr::select(microdata) %>%
tidyr::unnest(cols = c(microdata))
### 2016 
ephh2<- get_microdata(year=2016, trimester = 2:4, type = "hogar")
ephh2<- ephh2 %>%
dplyr::select(microdata) %>%
tidyr::unnest(cols = c(microdata))

ephh<- bind_rows(ephh,ephh2)
ephh<- ephh %>% arrange(-ANO4, -TRIMESTRE)

### mergeado

ephtotal<- left_join(ephi,ephh)

### aglomerado
aglomerado<- read_excel("aglomerado.xlsx",sheet = 4)

### Sector
sectorcaes<- read.csv("SECTORESCAES.csv", sep=",", header = T, encoding = "UTF-8", colClasses = "character")

### provincia

provincia<- read.csv("provincias.csv", sep=",", header = T)
provincia1<- provincia %>% select(PROVINCIA,CH15_COD)
provincia2<- provincia %>% select(PROVINCIA,CH16_COD)

ephtotal<- ephtotal %>% filter(ESTADO!=0) %>%  mutate(Sexo=as.character(CH04),
                      Sexo=case_when(Sexo=="1" ~ "Hombres",
                                       Sexo=="2" ~ "Mujeres"),
                      PP04D_COD = case_when(nchar(PP04D_COD) == 5 ~ PP04D_COD,
                                              nchar(PP04D_COD) == 4 ~ paste0("0", PP04D_COD),
                                              nchar(PP04D_COD) == 3 ~ paste0("00", PP04D_COD),
                                              nchar(PP04D_COD) == 2 ~ paste0("000", PP04D_COD),
                                              nchar(PP04D_COD) == 1 ~ paste0("0000", PP04D_COD)),
                        CALIFICACION = substr(PP04D_COD, 5, 5),                      
                        JERARQUIA = substr(PP04D_COD, 3, 3),
                        JERARQUIA = case_when(JERARQUIA=="0" ~ "Dirección",
                                              JERARQUIA=="2" ~ "Jefes",
                                              JERARQUIA=="1" ~ "Cuentapropia",
                                              JERARQUIA=="3" ~ "Trabajadores\nAsalariados"),
                        JERARQUIA = factor(JERARQUIA, c("Dirección", "Jefes", "Trabajadores\nAsalariados", "Cuentapropia")),
                        PEA= case_when(ESTADO==3 ~ 0,
                                       ESTADO==4 ~ 0,
                                       ESTADO==1 ~ 1,
                                       ESTADO==2 ~ 1),
                        PP04D_COD = as.character(PP04D_COD),
    
                        CALIFICACION = case_when(CALIFICACION=="1" ~ "Profesionales",
                                                   CALIFICACION=="2" ~ "Técnicos",
                                                   CALIFICACION=="3" ~ "Operativos",
                                                   CALIFICACION=="4" ~ "No Calificados"),
                        CALIFICACION = factor(CALIFICACION, c("No Calificados", "Operativos", "Técnicos", "Profesionales")),
                          PP04B_COD=as.character(PP04B_COD),
                          PP04B_COD=case_when(nchar(PP04B_COD)==4~PP04B_COD,
                                              nchar(PP04B_COD)==1~ paste0("0",PP04B_COD,"00"),
                                              nchar(PP04B_COD)==2~ paste0(PP04B_COD,"00"),
                                              nchar(PP04B_COD)==3~ paste0("0",PP04B_COD)),
                          SECTOR= substr(PP04B_COD,1,2),
                          HORASSEM=PP3E_TOT+PP3F_TOT,
                          niveled=case_when(NIVEL_ED==1 | NIVEL_ED==7 ~ "Sin\ninstrucción",
                                            NIVEL_ED %in% c(2,3) ~ "Primario\nCompleto",
                                            NIVEL_ED %in% c(4,5)~ "Secundario\nCompleto",
                                            NIVEL_ED == 6 ~ "Superior/Universitario\ncompleto"),
                          niveled=factor(niveled, levels = c("Sin\ninstrucción","Primario\nCompleto","Secundario\nCompleto","Superior/Universitario\ncompleto")))
  


ephtotal<- left_join(ephtotal,aglomerado)
ephtotal<- left_join(ephtotal, sectorcaes)
```

## Carga de datos
Para comenzar, cargamos los datos de las variables sociales y economicas que definen a las distintas provincias de la Argentina.
```{r echo = FALSE, warning=FALSE, error=FALSE, message=FALSE}
datos<- read_csv("macroloc_para_r.csv",col_names = T, row.names(1))
datos3<- datos %>% select(-Provincia)
row.names(datos3)<- datos$Provincia
datos4<- datos3
#datos<- datos %>% mutate(`Densidad poblacional: Hab/km² (2010)`=log(`Densidad poblacional: Hab/km² (2010)`))
```

## Normalización de la base de datos
Ahora normalizamos la base de datos para lograr coherencia en la aplicación de K-means, debido a quen trabajamos con distintas escalas de datos.
```{r echo = FALSE, warning=FALSE, error=FALSE}
datos3<-datos3 %>% select(-c(`Densidad poblacional: Hab/km² (2010)`))
datos_norm<- scale(datos3)
```
## Número de clusters óptimo
Verificamos el numero de clusters optimos a través de el Within-cluster sum of square, el cual es un indicador que mide la suma de las distancias entre las variables dentro de  los cluster y sus centroides, la idea es minimizar esta discrepancia dentro de cada grupo, teniendo en cuenta el trade-off que implica cuando este es mínimo, el cual es el caso en que el numero de clusters es igual al número de variables a clusterizar, en donde si tenemos j observaciones, el numero de clusters sería tal que j=k, y no se estaría dando ninguna información relevante a los efectos de poder resumir caracteristicas comunes entre los grupos.

\begin {center}
$WCSS=\sum_{i=1}^{N_{C}} \sum_{\textbf{x}\in Ci} distancia(\textbf{x},\bar {\textbf x} _{\textbf{Ci}})$ 
\end {center}
```{r echo = FALSE, warning=FALSE, error=FALSE}
factoextra::fviz_nbclust(datos_norm,kmeans, method="wss")+ geom_vline(xintercept = 3, colour="RED", linetype="dotted") + theme_classic() + labs(title="Numero óptimo de clusters") + xlab("Número de clusters") + ylab("WSS")+ theme(text=element_text(family = "LM Roman 10"), title = element_text(face = "bold"))

```
Obtenemos que el numero óptimo de clusters se encuentra en torno al **número 3**, debido a que la contribución marginal de aumentar el numero de  clusters a 4, no aportaría una reducción muy elevada al **WSS**, y seguiriamos perdiendo generalidad en la clusterización de los grupos sin una ganancia significativa de similitud dentro de los grupos.

## Cómputo de las K-means 
Se realiza un seteo de una semilla para el cálculo de los centroides iniciales del algoritmo de K-means y se procederá a realizar el cálculo de los clusters a través de 1000 iteraciones, eligiendo la que arroje un menor numero de WSS.
```{r echo = FALSE, warning=FALSE, error=FALSE}
set.seed(1118)
km_clusters<- kmeans(datos_norm,centers = 3,iter.max = 1000,nstart = 2000)
nomenclador<- km_clusters$cluster
```
Podemos ver la media de los parámetros para cada uno de los clusters
```{r echo = FALSE, warning=FALSE, error=FALSE}
resumen_cluster<-aggregate(datos3,by = list(cluster=km_clusters$cluster),FUN = median)
resumen_g<-resumen_cluster %>% pivot_longer(-cluster)
resumen2<-data.frame(t(resumen_cluster)) 
resumen2<- resumen2 %>% rename("Cluster 1"=X1,"Cluster 2"=X2, "Cluster 3"=X3) %>% rownames_to_column()
resumen2<- resumen2 %>% rename("Indicadores"=rowname)
resumen2<- resumen2 %>% filter(Indicadores!="cluster")
resumen2$`Cluster 1`<- formattable::comma((resumen2$`Cluster 1`),2)
resumen2$`Cluster 2`<- formattable::comma((resumen2$`Cluster 2`),2)
resumen2$`Cluster 3`<- formattable::comma((resumen2$`Cluster 3`),2)
resumen2$`Cluster 1`[1]<- formattable::comma((resumen2$`Cluster 1`[1]),0)
resumen2$`Cluster 2`[1]<- formattable::comma((resumen2$`Cluster 2`[1]),0)
resumen2$`Cluster 3`[1]<- formattable::comma((resumen2$`Cluster 3`[1]),0)


kableExtra::kable(resumen2,format = "markdown",caption = "Resumen de indicadores por cluster")
#xtable(resumen2, type="latex",auto = TRUE)
```
agregamos a la base de datos original la denominación de cada cluster
```{r include=FALSE}
#agregamos a la base de datos original la denominación de cada cluster

datos<- cbind(datos,cluster=nomenclador)
clustersprov<-datos %>% select(Provincia,cluster)
datos %>% group_by(cluster) %>% summarise(habitantes=sum(`Habitantes (2010)`))
datos %>% group_by(cluster) %>% summarise(Provincia)
datos<- datos %>% mutate(Provincia=case_when(Provincia=="Tierra del Fuego, Antártida e Islas del Atlántico Sur (4)"~ "Tierra del Fuego, Antártida e Islas del Atlántico Sur",
                                             TRUE~Provincia)) %>% arrange(Provincia)
```

```{r echo = FALSE, warning=FALSE, error=FALSE, fig.align='center'}
fviz_cluster(km_clusters, data = datos4,
palette = c("RED", "BLUE","GREEN"),
ellipse.type = "euclid", # Concentration ellipse
star.plot = TRUE, # Add segments from centroids to items
repel = TRUE, # Avoid label overplotting (slow)
 labelsize = 6, ) + theme_classic(base_family ="LM Roman 10" ) + labs(title="Plot de clusters resultantes de la macrolocalización") + theme(text=element_text(family = "LM Roman 10"), title = element_text(face = "bold"))
```
Se puede ver claramente la diferencia en la similitud de los tres grupos, siendo solamente la Capital Federal la única que presenta mayor disimilitud con respecto a su cluster, lo cual indica que esta capital lleva una dinámica socio-económica muy peculiar con respecto al promedio de las provincias argentinas, inclusive considerablemente distinta que las provincias con la cual ostenta mayor similitud.

```{r include=FALSE}

#ephtotal<- read_rds("ephtotal.Rds")
### provincia

provincia<- read.csv("provincias.csv", sep=",", header = T, encoding = "UTF-8")
provincia<- provincia %>% arrange(PROVINCIA)
provincia1<- provincia %>% select(PROVINCIA,CH15_COD)
provincia2<- provincia %>% select(PROVINCIA,CH16_COD)
#
nombredato<- datos %>% select(Provincia)
nombredato

name_prov_para_datos<-bind_cols(nombredato, provincia) %>% select(-PROVINCIA)
datos<- left_join(datos,name_prov_para_datos)
#
cluster_nombres_eph<- datos %>% select(c("Provincia","cluster","CH15_COD","CH16_COD"))
cluster_nombres_eph<- cluster_nombres_eph %>% rename(provincia_origen=Provincia, cluster_origen=cluster)
cluster_nombres_eph_ch15<-cluster_nombres_eph %>% select(provincia_origen,CH15_COD, cluster_origen)
##############################################################################################
ephinmi<- ephtotal %>% filter(CH15==3) 
ephinmi<- left_join(ephinmi, cluster_nombres_eph_ch15) 

ephinmi %>% filter(!is.na(SECTOR_ACT)) %>% group_by(SECTOR_ACT) %>% summarise(porcentaje=formattable::percent (sum(PONDERA)/sum(ephinmi$PONDERA[!is.na(SECTOR_ACT)]))) %>% arrange(-porcentaje)

ephinmi %>% filter(!is.na(CALIFICACION)) %>% group_by(CALIFICACION) %>% summarise(porcentaje=formattable::percent (sum(PONDERA)/sum(ephinmi$PONDERA[!is.na(CALIFICACION)]))) %>% arrange(-porcentaje)

```

```{r include=FALSE}
ephinmi<- ephinmi %>% filter(!is.na(provincia_origen))
prov_por_aglo<- read_csv("provincias_por_aglomerado.csv")
cluster_destino<- cluster_nombres_eph %>% select(provincia_origen,cluster_origen) %>% rename(provincia_destino=provincia_origen, cluster_destino=cluster_origen)
cluster_destino<- left_join(prov_por_aglo,cluster_destino)

ephinmi<- left_join(ephinmi,cluster_destino)
```

```{r include=FALSE}
cuadro_4<- ephinmi %>% group_by("Provincia"=provincia_destino) %>% summarise("Inmigrantes"=sum(PONDERA))
cuadro_5<- ephinmi %>% group_by("Provincia"=provincia_origen) %>% summarise("Emigrantes"=sum(PONDERA))
cuadro_6<- full_join(cuadro_4,cuadro_5)
######
prov_aglo<- prov_por_aglo %>% rename(provincia=provincia_destino)
ephtotal<- left_join(ephtotal, prov_aglo)
prov_cluster<- clustersprov %>% mutate(Provincia=case_when(Provincia=="Tierra del Fuego, Antártida e Islas del Atlántico Sur (4)"~ "Tierra del Fuego, Antártida e Islas del Atlántico Sur",                              TRUE ~ Provincia))
#######
cuadro_7<- ephtotal %>% group_by("Provincia"=provincia) %>% summarise("Poblacion"=sum(PONDERA))
cuadro_8<- left_join(cuadro_6,cuadro_7)
cuadro_8<- left_join(cuadro_8,prov_cluster)
cuadro_8<- cuadro_8 %>% mutate(tasa_inmigracion=Inmigrantes/Poblacion, tasa_emigracion=Emigrantes/Poblacion, tasa_neta=tasa_inmigracion-tasa_emigracion)
cuadro_8$cluster<- factor(cuadro_8$cluster, levels = c("1","2","3"))
```

```{r include=FALSE}
### Mapa de migraciony emigracion por provincia

datos_mapa_prov<- st_read( "./mapa/gadm36_ARG_1.shp")
datos_mapa_prov<- datos_mapa_prov %>% rename(Provincia=NAME_1)

datos_mapa_prov<- datos_mapa_prov %>% mutate(Provincia=case_when(Provincia=="Ciudad de Buenos Aires"  ~ "Ciudad Autónoma de Buenos Aires",
                                                       Provincia=="Tierra del Fuego"  ~"Tierra del Fuego, Antártida e Islas del Atlántico Sur",
                                                       TRUE~Provincia))
cuadro_9<- cuadro_8 %>% mutate(tasa_inmigracion=formattable::percent(tasa_inmigracion),tasa_emigracion=formattable::percent(tasa_emigracion))
datos_mapa_prov<- inner_join(datos_mapa_prov, cuadro_9)
```
## Mapa de las provincias Argentinas divididas por Cluster
```{r echo = FALSE, warning=FALSE, error=FALSE, fig.align='center'}
mapa_cluster<- ggplot(data = datos_mapa_prov) + geom_sf(aes(fill=cluster),color="BLACK", size=0.2 ) + labs(fill="Cluster:") + scale_fill_manual(values=color)+ theme(text=element_text(family="LM Roman 10"), panel.background = element_blank() , axis.text = element_blank(), axis.ticks = element_blank())
mapa_cluster
```


## Flujos migratorios entre clusters

Dentro de los cluster, existen provincias de las cuales salen gran cantidad de inmigrantes, al igual que existen provincias que son receptoras de estos mismos, en primer lugar caracterizaremos cual es el cluster con mayor nivel de *expulsion* de inmigrantes interprovinciales.
```{r}
cuadro_2<-ephinmi %>% group_by("Cluster"=cluster_origen) %>% summarise("Porcentaje"=formattable::percent((sum(PONDERA)/sum(ephinmi$PONDERA))))
kableExtra::kable(cuadro_2,format = "markdown",caption = "Cluster de origen de los migrantes")
```
Se puede notar que las provincias del **cluster Nº2** son las que mayor nivel de expulsión poseen, seguidas por las provincias pertenecientes al cluster Nº3, y por úlitmo se encuentran las pertenecientes al cluster Nº1.

```{r echo = FALSE, warning=FALSE, error=FALSE}
cuadro_3<-ephinmi %>% group_by("Cluster"=cluster_destino) %>% summarise("Porcentaje"=formattable::percent((sum(PONDERA)/sum(ephinmi$PONDERA))))
kableExtra::kable(cuadro_3,format = "markdown",caption = "Cluster de destino de los migrantes")
```
Sin embargo, viendo cuales son los cluster de destino  con mayor porcentaje  de migrantes, encontramos que el **cluster Nº 3** es el que mayor nivel de *atracción* posee por elevada diferencia (`r cuadro_3 %>% filter(Cluster==3) %>% pull()`) 

```{r echo = FALSE, warning=FALSE, error=FALSE}
cuadro_8 %>% ggplot(mapping=aes(x=tasa_inmigracion,y = tasa_emigracion, label=Provincia, color=cluster)) + geom_point(show.legend = T) + geom_abline(intercept=-0,slope = 1)+ scale_color_manual(values = color)+ scale_y_continuous(labels = scales::percent_format(),limits = c(0,0.75))+scale_x_continuous(labels = scales::percent_format(),limits = c(0,0.75)) + xlab("Tasa de inmigración") + ylab("Tasa de emigración")+ labs(title = "Tasa de inmigración y emigración por provincia", color="Cluster:")+ ggrepel::geom_text_repel(size=3,family = "LM Roman 10",show.legend = F)+theme(text=element_text(family = "LM Roman 10"),axis.line = element_line(color="BLACK") ,axis.text = element_text(size=7, color = "BLACK") , panel.background = element_blank(),  axis.title = element_text(size=7), title = element_text(face = "bold"), legend.key = element_blank())
```
```{r fig.align='center'}
mapa_inmigracion<-ggplot(data = datos_mapa_prov) + geom_sf(aes(fill=tasa_inmigracion),color="BLACK", size=0.2 ) + viridis::scale_fill_viridis(label=scales::percent) + labs(fill="Tasa de inmigración:") + theme(text=element_text(family="LM Roman 10"), panel.background = element_blank() , axis.text = element_blank(), axis.ticks = element_blank()) 
mapa_emigracion<- ggplot(data = datos_mapa_prov) + geom_sf(aes(fill=tasa_emigracion),color="BLACK", size=0.2 ) + viridis::scale_fill_viridis(label=scales::percent) + labs(fill="Tasa de emigración:") + theme(text=element_text(family="LM Roman 10"), panel.background = element_blank() , axis.text = element_blank(), axis.ticks = element_blank()) 
gridExtra::grid.arrange(mapa_emigracion,mapa_inmigracion, ncol=2)
```

## Definición de migrante según cluster de origen
En primer lugar se analizará si existen microdeterminantes dentro de las características de los migrantes que porovoquen que ciertas personas con tengan una mayor propensión a migrar desde ciertas localizaciones, es decir, se analizaran los factores de expulsión de los distintos cluster; por otro lado, se realizará un análisis diferenciando el destino de los distintos migrantes, con el fin de establecer los determinantes de atracción de las distintas localizaciones.

## Factores determinantes de expulsión de los migrantes
En el universo de habitantes de una determinada región/cluster, pueden existir caracteristicas determinadas que diferencien de manera significativa entre las personas que nacieron  y decidieron quedarse en la misma región, de las que si bien nacieron en la misma región, optaron por migrar hacia otra. A continuación se realizará un análisis diferenciando por cluster  de características socioeconómicas de los migrantes y no migrantes  que nacieron en un mismo cluster, con el fin de determinar si existen diferencias significativas entre ellos.

```{r include=FALSE}
#Creación de regresores (feature engineerirng)
deflactor<- read_csv("deflactor.csv")
canastas<- read.csv("canasta.csv", sep=";", dec=".", header = TRUE)

ephtotal<- left_join(ephtotal, deflactor)
ephtotal<- ephtotal %>% mutate(HIJO=case_when(CH03==3~1,
                                              TRUE ~ 0))

ephtotal<- ephtotal %>% group_by(ANO4, TRIMESTRE, CODUSU,NRO_HOGAR) %>% mutate(HIJO_HOGAR=sum(HIJO)) %>% ungroup()
ephtotal<- left_join(ephtotal,eph::adulto_equivalente)
ephtotal<- left_join(ephtotal,canastas)
ephtotal<- ephtotal %>% group_by(ANO4, TRIMESTRE, CODUSU,NRO_HOGAR) %>% mutate(EAF=sum(adequi)) %>% ungroup()
ephtotal<- ephtotal %>% mutate(CBAEQ=CBA*EAF,
                         CBTEQ=CBT*EAF)
ephtotal<- ephtotal %>% mutate(condicion=case_when(ITF<CBAEQ ~ "Indigente",
                                             ITF>=CBAEQ & ITF<CBTEQ ~ "Pobre",
                                             ITF>=CBTEQ ~ "No Pobre"))


ephtotal<- ephtotal %>% mutate(hombre=case_when(Sexo=="Hombres"~1,
                                                                    Sexo=="Mujeres"~0),
                                                   edad=case_when(CH06=="-1" ~ as.integer(1),
                                                                  TRUE ~ as.integer(CH06)),
                                                   edad2=(edad)^2,
                                                   ledad=log(edad),
                                                   medio=case_when(niveled=="Secundario\nCompleto"~ 1,
                                                                    TRUE ~ 0),
                                                   alto=case_when(niveled=="Superior/Universitario\ncompleto"~ 1,
                                                                    TRUE ~ 0),
                                                    IPCFR=IPCF/DEFLACTOR,
                                                    IPCFRL=log(IPCFR),
                                                    OCUPADO_BAJO=case_when(ESTADO==1 & CALIFICACION %in% c("No Calificados", "Operativos") ~ 1,
                                                                      TRUE ~ 0),
                                                    OCUPADO_ALTO=case_when(ESTADO==1 & CALIFICACION %in% c("Profesionales","Técnicos") ~ 1,
                                                                      TRUE ~ 0),
                                                    PROPIETARIO=case_when(II7==1 | II7==2 ~ 1,
                                                                          TRUE ~ 0),
                                                    HIJO_DUMMY=case_when(HIJO_HOGAR==0 ~ 0,
                                                                         TRUE ~ 1),
                                                    CASADO= case_when(CH07==1 | CH07==2 ~ 1 ,
                                                                      TRUE ~ 0),
                                                    SOLTERO_C_HIJO=case_when(CASADO==0 & HIJO_DUMMY==1~1,
                                                                             TRUE~0),
                                                    CASADO_S_HIJO=case_when(CASADO==1 & HIJO_DUMMY==0~ 1,
                                                                            TRUE ~ 0),
                                                    CASADO_C_HIJO=case_when(CASADO==1 & HIJO_DUMMY==1~1,
                                                                            TRUE~0),
                                                    POBRE=case_when(condicion %in% c("Pobre","Indigente")~1,
                                                                    TRUE ~ 0),
                                                    SUBSIDIO=case_when(V5==1 ~ 1,
                                                                       TRUE ~ 0)
                                                   )
```

```{r include = FALSE}
cluster1_expulsion<- left_join(ephtotal,cluster_destino)  
cluster1_expulsion<- left_join(cluster1_expulsion,cluster_nombres_eph_ch15)
cluster1_expulsion<- cluster1_expulsion %>%  filter(cluster_destino==1 | cluster_origen==1)
cluster1_expulsion<- cluster1_expulsion %>% filter(CH03==1)
cluster1_expulsion<- cluster1_expulsion %>% filter(CH15%in% c(1,2,3))
cluster1_expulsion<- cluster1_expulsion %>% mutate(inmigrante=case_when(cluster_origen==1  &  CH15==3 &   cluster_destino!=1 ~1,
                                                                        cluster_destino==1 & CH15 %in% c(1,2) ~0))
cluster1_expulsion<- cluster1_expulsion %>% filter(!is.na(inmigrante))

cluster_exp1<- glm(inmigrante ~  hombre + POBRE + SUBSIDIO + OCUPADO_BAJO+OCUPADO_ALTO +  SOLTERO_C_HIJO+CASADO_S_HIJO + CASADO_C_HIJO+ PROPIETARIO+  + edad + edad2  + medio + alto ,data = cluster1_expulsion,family = binomial(link="logit"))

```
```{r include = FALSE}
cluster2_expulsion<- left_join(ephtotal,cluster_destino)  
cluster2_expulsion<- left_join(cluster2_expulsion,cluster_nombres_eph_ch15)
cluster2_expulsion<- cluster2_expulsion %>%  filter(cluster_destino==2 | cluster_origen==2)
cluster2_expulsion<- cluster2_expulsion %>% filter(CH15%in% c(1,2,3))
cluster2_expulsion<- cluster2_expulsion %>% filter(CH03==1)
cluster2_expulsion<- cluster2_expulsion %>% mutate(inmigrante=case_when(cluster_origen==2  &  CH15==3 &   cluster_destino!=2~1,
                                                                        cluster_destino==2 & CH15 %in% c(1,2) ~0))
cluster2_expulsion<- cluster2_expulsion %>% filter(!is.na(inmigrante))

cluster_exp2<- glm(inmigrante ~  hombre + POBRE + SUBSIDIO + OCUPADO_BAJO+OCUPADO_ALTO +  SOLTERO_C_HIJO+CASADO_S_HIJO + CASADO_C_HIJO+ PROPIETARIO+  + edad + edad2  + medio + alto, data= cluster2_expulsion,family = binomial(link = "logit"))
```

```{r include = FALSE}
cluster3_expulsion<- left_join(ephtotal,cluster_destino)  
cluster3_expulsion<- left_join(cluster3_expulsion,cluster_nombres_eph_ch15)
cluster3_expulsion<- cluster3_expulsion %>%  filter(cluster_destino==3 | cluster_origen==3)
cluster3_expulsion<- cluster3_expulsion %>% filter(CH15%in% c(1,2,3))
cluster3_expulsion<- cluster3_expulsion %>% filter(CH03==1)
cluster3_expulsion<- cluster3_expulsion %>% mutate(inmigrante=case_when(cluster_origen==3  &  CH15==3 &   cluster_destino!=3 ~1,
                                                                        cluster_destino==3 & CH15 %in% c(1,2) ~0))
cluster3_expulsion<- cluster3_expulsion %>% filter(!is.na(inmigrante))

cluster_exp3<- glm(inmigrante ~  hombre + POBRE + SUBSIDIO + OCUPADO_BAJO+OCUPADO_ALTO +  SOLTERO_C_HIJO+CASADO_S_HIJO + CASADO_C_HIJO+ PROPIETARIO+  + edad + edad2  + medio + alto,data = cluster3_expulsion,family = binomial(link = "logit"))
```
```{r include= FALSE}
#Grafico de regresiones en stargazer
stargazer(cluster_exp1,cluster_exp2, cluster_exp3,font.size = "small")
summary(cluster_exp1)
```
\begin{table}[!htbp] \centering 
  \caption{} 
  \label{} 
\small 
\begin{tabular}{@{\extracolsep{5pt}}lccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{3}{c}{\textit{Variable dependiente:}} \\ 
\cline{2-4} 
\\[-1.8ex] & \multicolumn{3}{c}{Inmigrante} \\ 
\\[-1.8ex] & (Cluster 1) & (Cluster 2) & (Cluster 3)\\ 
\hline \\[-1.8ex] 
 Hombre & 0.008 & 0.031 & 0.121$^{***}$ \\ 
  & (0.037) & (0.020) & (0.027) \\ 
  & & & \\ 
 Pobre & 0.449$^{***}$ & 0.058$^{***}$ & $-$0.476$^{***}$ \\ 
  & (0.035) & (0.020) & (0.026) \\ 
  & & & \\ 
 Subsidio & $-$0.125$^{**}$ & $-$0.591$^{***}$ & 0.325$^{***}$ \\ 
  & (0.052) & (0.033) & (0.040) \\ 
  & & & \\ 
 Ocupado/a baja calif. & $-$0.092$^{**}$ & 0.004 & $-$0.190$^{***}$ \\ 
  & (0.041) & (0.023) & (0.031) \\ 
  & & & \\ 
 Ocupado/a alta calif. & $-$0.248$^{***}$ & $-$0.030 & $-$0.177$^{***}$ \\ 
  & (0.057) & (0.032) & (0.036) \\ 
  & & & \\ 
 Soltero/a con Hijo/a & $-$0.311$^{***}$ & $-$0.388$^{***}$ & 0.092$^{**}$ \\ 
  & (0.048) & (0.027) & (0.036) \\ 
  & & & \\ 
 Casado/a sin Hijo/a & 0.193$^{***}$ & 0.109$^{***}$ & 0.002 \\ 
  & (0.052) & (0.027) & (0.035) \\ 
  & & & \\ 
 Casado/a con Hijo/a & $-$0.249$^{***}$ & $-$0.254$^{***}$ & $-$0.116$^{***}$ \\ 
  & (0.045) & (0.024) & (0.032) \\ 
  & & & \\ 
 Propietario/a de Vivienda & $-$0.214$^{***}$ & $-$0.545$^{***}$ & 0.087$^{***}$ \\ 
  & (0.035) & (0.019) & (0.025) \\ 
  & & & \\ 
 Edad & 0.043$^{***}$ & $-$0.007$^{**}$ & 0.064$^{***}$ \\ 
  & (0.006) & (0.003) & (0.005) \\ 
  & & & \\ 
 Edad$^2$ & $-$0.0002$^{***}$ & 0.0002$^{***}$ & $-$0.001$^{***}$ \\ 
  & (0.0001) & (0.00003) & (0.00004) \\ 
  & & & \\ 
 Nivel Educativo Medio & $-$0.112$^{***}$ & $-$0.337$^{***}$ & 0.267$^{***}$ \\ 
  & (0.037) & (0.021) & (0.027) \\ 
  & & & \\ 
 Nivel Educativo Alto & 0.131$^{**}$ & $-$0.436$^{***}$ & 0.406$^{***}$ \\ 
  & (0.052) & (0.029) & (0.033) \\ 
  & & & \\ 
 Constante & $-$2.672$^{***}$ & $-$1.280$^{***}$ & $-$3.888$^{***}$ \\ 
  & (0.154) & (0.080) & (0.112) \\ 
  & & & \\ 
\hline \\[-1.8ex] 
Observaciones(n) & 26,688 & 110,337 & 110,180 \\ 
Log Likelihood & $-$13,238.230 & $-$45,180.400 & $-$31,683.570 \\ 
Akaike Inf. Crit. & 26,504.470 & 90,388.810 & 63,395.150 \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Nota:}  & \multicolumn{3}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table} 

Los factores determinantes de expulsión de los migrantes varían dependiendo del cluster que se esté tomando a consideración, el sexo no es un factor determinante de expulsión para los cluster 1 y 2, sin embargo, si lo es para el cluster 3, en el cual los hombres que nacieron en el mismo tienen una mayor probabilidad de migrar que las mujeres; la edad, por otro lado, tiene una relación positiva con la probabilidad de migrar para los tres clusters, lo que indica que la probabildiad de migrar aumenta conforme la persona es mayor, particularmente para el cluster 3 existe una relación cuadrática significativa, en donde cada año que pasa esta probabilidad crece a tasa decreciente,lo que genera que cada año que aumente la edad aportará cada vez menos en el aumento de  la probabilidad de ser migrante.

La incidencia en la pobreza es un factor determinante significativo en la migración en los tres clusters, para los cluster 1 y 2 las personas pobres que nacieron en los mismos tienen una mayor probabilidad de abandonar sus provincias de origen, mientras que la incidencia en la pobreza para los oriundos del cluster 3 tiene un efecto totalmente inverso, reduciendo al probabilidad de abandonar su provincia natal.

La recepción de susidios o ayudas por parte del gobierno, instituciones, iglesias, etc, tiene un impacto significativo en la probabilidad de migracion en los tres clusters, pero nuevamente se puede ver un patron diferenciado entre los cluster 1 y 2, en donde la recepción de un subsidio disminuye la probabibilidad de ser migrante, mientras que en el cluster 3 el efecto es contrario, en donde la recepción de esta transferencia económica aumenta la probabilidad de abandonar la provincia de origen.

En cuanto a la condición de ocupación y la calificación del trabajo, los cluster 1 y 3 tienen efectos similares en cuanto a este factor determinante de la migración, en donde la probabilidad de migrar se reduce en presencia de un trabajo de baja calificación en relación a una persona que está desocupada o inactiva (en adelante grupo base), este efecto se intensifica y se generaliza en los tres clusters si la condición de ocupacioón de la persona es en un trabajo de alta calificación, en donde la probabildiad de migrar se reduce en comparación con el grupo base, lo cual indica que una persona con un trabajo de calificación alta tiene menos probabilidad de ser migrante de su provincia de origen para los tres clusters.

otro factor relevante a la hora de analizar los factores de expulsión de los cluster es la organización familiar, en este caso, en el cluster 1 y 2 ser soltero con hijos disminuye la porbabilidad de abandonar la provincia de origen en comparación con una persona soltera sin hijos (en adelante grupo base), mientras que en el cluster 3 el efecto es inverso, donde ser soltero con hijos aumenta la probabildiad de migrar, en relación con el grupo base.
La similitud entre el cluster 1 y 2 se vuelve a repetir si consideramos el auimento en la probabildiad de ser migrante en el caso de ser estar en pareja (casado o unido) SIN hijos, en comparación el grupo base, en donde la condición de estar en pareja reforzaría la decisión de migración, lo cual queda revertido en el caso de las personas que estan casadas pero con hijos, el cual para todos los cluster es un factor determinante negativo que reduce la probabilidad de migrar en relación al grupo base y es estadísticamente significativo.

La propiedad de la vivienda es otro factor que tiene efectos diferenciados en la decisión de migración dependiendo del cluster que se esté analizando, para los cluster 1 y 2, el hecho de ser propietario/a de la vivienda reduce la probabilidad de ser un migrante con origen en estas provincias en relación con las personas que no son propietarias de las viviendas (en adelante grupo base), sin embargo, para el cluster 3 este efecto es inverso, el cual indica que la propiedad de la vivienda aumenta la probailidad de haber abandonado su provincia de origen en relación con el grupo base.

Por último se analiza el efecto que tiene la educación en la expulsión de la provincia de origen, para el  cluster 1  una persona con nivel educativo medio (secundaria completa) tiene menor probabildiad de haber abandonado la provincia de origen en relación con una persona con un nivel educativo bajo (en adelante grupo base), sin embargo, para los cluster 2 y 3 esta probabildiad es inversa, en donde una persona con nivel educativo medio tiene una mayor probabilidad de ser migrante en relación al grupo base, misma relación se repite si se considera una persona con nivel educativo alto (educación superior o universitaria), en donde para el cluster 1 y 3 la probabildiad de ser migrante aumenta en comparación con el grupo base, generando una expulsión de personas con elevado nivel educativo, lo cual es inverso en el cluster 2, el cual la probabildiad de migrar se reduce en comparación con el grupo base si se posee un nivel educativo superior o universitario .

## Factores determinantes de atracción de los migrantes
El deseo de migrar es distinto a la acción de migración, entre el deseo y el hecho existen multiples barreras y condicionantes que impiden su concreción, es por ello que el análisis de los factores que determinarán la atracción de las personas hacia los distintos clusters se realiza con respecto a la muestra en el período de relevancia de personas que efectivamente migraron. 

La distinción se realiza en torno a los factores que determinan que un migrante elija como destino alguno de los clusters, se busca analizar si existen diferencias significativas en las características de un migrante dependiendo del cluster que elige como destino de migración.

```{r include=FALSE}
cluster1_atraccion<- left_join(ephtotal,cluster_destino)  
cluster1_atraccion<- left_join(cluster1_atraccion,cluster_nombres_eph_ch15)
cluster1_atraccion <- cluster1_atraccion %>% filter(CH15==3)
cluster1_atraccion<- cluster1_atraccion %>% mutate(inmigrante=case_when(cluster_destino==1 ~1,
                                                                        (cluster_destino==2 | cluster_destino==3)~0)) 
cluster1_atraccion<- cluster1_atraccion %>% filter(!is.na(inmigrante))

cluster1_atraccion %>% group_by(inmigrante) %>% count()

cluster_atr1<- glm(inmigrante ~  hombre + POBRE + SUBSIDIO + OCUPADO_BAJO+OCUPADO_ALTO +  SOLTERO_C_HIJO+CASADO_S_HIJO + CASADO_C_HIJO+ PROPIETARIO+  + edad + edad2  + medio + alto ,data = cluster1_atraccion,family = binomial(link="logit"))
summary(cluster_atr1)
```

```{r include=FALSE}
cluster2_atraccion<- left_join(ephtotal,cluster_destino)  
cluster2_atraccion<- left_join(cluster2_atraccion,cluster_nombres_eph_ch15)
cluster2_atraccion <- cluster2_atraccion %>% filter(CH15==3)
cluster2_atraccion<- cluster2_atraccion %>% mutate(inmigrante=case_when(cluster_destino==2 ~1,
                                                                        (cluster_destino==1 | cluster_destino==3)~0)) 
cluster2_atraccion<- cluster2_atraccion %>% filter(!is.na(inmigrante))

cluster2_atraccion %>% group_by(inmigrante) %>% count()

cluster_atr2<- glm(inmigrante ~  hombre + POBRE + SUBSIDIO + OCUPADO_BAJO+OCUPADO_ALTO +  SOLTERO_C_HIJO+CASADO_S_HIJO + CASADO_C_HIJO+ PROPIETARIO+  + edad + edad2  + medio + alto ,data = cluster2_atraccion,family = binomial(link="logit"))
summary(cluster_atr2)
```

```{r include=FALSE}
cluster3_atraccion<- left_join(ephtotal,cluster_destino)  
cluster3_atraccion<- left_join(cluster3_atraccion,cluster_nombres_eph_ch15)
cluster3_atraccion <- cluster3_atraccion %>% filter(CH15==3)
cluster3_atraccion<- cluster3_atraccion %>% mutate(inmigrante=case_when(cluster_destino==3 ~1,
                                                                        (cluster_destino==1 | cluster_destino==2)~0)) 
cluster3_atraccion<- cluster3_atraccion %>% filter(!is.na(inmigrante))

cluster3_atraccion %>% group_by(inmigrante) %>% count()

cluster_atr3<- glm(inmigrante ~  hombre + POBRE + SUBSIDIO + OCUPADO_BAJO+OCUPADO_ALTO +  SOLTERO_C_HIJO+CASADO_S_HIJO + CASADO_C_HIJO+ PROPIETARIO+  + edad + edad2  + medio + alto ,data = cluster3_atraccion,family = binomial(link="logit"))
summary(cluster_atr3)
```

```{r include= FALSE}
stargazer(cluster_atr1,cluster_atr2, cluster_atr3,font.size = "small")
```

El sexo es un determinante significativo para los migrantes a la hora de elegir su lugar de destino, los migrantes hombres tienen una mayore probabilidad de seleccionar como lugar de destino a las provincias del cluster 1 y 2, lo cual es inverso para las provincias del cluster 3, el cual tiene una mayor probabilidad de selección si la migrante es mujer. La edad de los migrantes tiene un efecto muy diferenciado dependiendo del cluster que se esté considerando como destino, para los migrantes que eligen el cluster 1, la edad es un determinante negativo, el cual genera que cuanto mayor sea la edad del migrante, menor sea la probabilidad que elija el cluster 1 como destino, para el cluster 2 y 3 la relación con la edad de los migrantes es cuadrática, siendo que ante una mayor edad se reduce la probabilidad de elegir como destino de migración el cluster 2, pero cada año que se suma tiene un efecto negativo cada vez menor, efecto totalmente inverso tiene la edad en los que eligen como destino de migración el cluster 3, para los cuales la edad es un factor que afecta positivamente a la probabildiad de migrar hacia este cluster, pero cada año que se suma tiene un efecto positivo cada vez menor. 

La incidencia en la pobreza es un factor socioeconómico que es relevante a la hora de que un migrante decida su cluster de destino, la probabildiad de que una persona pobre elija como destino los cluster 1 y 2, ceteris paribus, es mayor que la de una persona NO-pobre, sin embargo, esta relación se invierte si se considera como destino el cluster 3, en donde la probabildiad de que un migrante lo elija como destino es menor en el caso de una persona pobre.

La recepción de susidios o ayudas por parte del gobierno, instituciones, iglesias, etc, tiene un impacto significativo en la probabilidad de elegir como destino alguno de los tres clusters, sin embargo el patron es distino dependiendo de cluster que se tome como destino, la recepción de un subsidio disminuye la probabibilidad de elegir como destino el cluster 1 y 3, mientras que en el cluster 2 el efecto es contrario, en donde la recepción de esta transferencia económica aumenta la probabilidad de elegir como destino este cluster.

La situación y cualidad ocupacional es un factor determinante para la elección del cluster de destino para los migrantes, para los cluster 1 y 2 la dirección del efecto de este determninante es similar, la probabilidad de elegir como destino de migración alguno dee estos cluster se reduce en presencia de un trabajo de baja calificación en relación a una persona que está desocupada o inactiva (en adelante grupo base), y este efecto se invierte si la condición de ocupación de la persona es en un trabajo de alta calificación, en donde la probabildiad de elegir como destino de migración el cluster 1 y 2 aumenta en comparación con el grupo base, lo cual indica que un migrante con un trabajo de calificación alta tiene, ceteris paribus, mayor probabilidad en comparación con el grupo base de elegir como destino a provincias que pertenezcan al cluster 1 y 2. Para las provincias del cluster 3 encontramos una situación disimil, en donde la probabilidad de elegir como destino de migración este cluster aumenta en presencia de un trabajo de baja calificación en relación a una persona que está desocupada o inactiva (en adelante grupo base), y este efecto se invierte si la condición de ocupación de la persona es en un trabajo de alta calificación, lo que hace menos probable (ceteris paribus, en relación con el grupo base) que un migrante con un trabajo de calificación alta elija como provincia de destino a alguna de las pertenecientes al cluster 3.

La organización familiar vuelve a jugar un papel relevante en la elección  de los migrantes en torno al cluster de destino, en este caso, ser soltero/a con hijos/as aumenta la probabilidad de que un migrante sea atraido como lugar de destino por los cluster 1 y 2 en comparación con una persona soltera sin hijos (en adelante grupo base), mientras que para el cluster 3 el efecto es inverso, donde ser soltero con hijos disminuye la probabilidad de elegir como destino este cluster, en relación con el grupo base.

Los migrantes que estan en pareja (casado o unido) SIN hijos tienen una mayor probabilidad de elegir como destino de migración el cluster 1 y 3, en comparación el grupo base, situación inversa se configura si se considera como destino alguna de las provincias del cluster 2, en donde estar en pareja SIN hijos disminuye la probabildiad de elegir como destino este cluster en comparación con el grupo base.  En el caso de las personas que estan casadas  CON hijos, tienen mayor probabilidad de elegir como destino los cluster 1 y 2 en comparación con el grupo base, situación inversa se da en los migrantes casados CON hijos que que ven reducida su probabilidad de elegir como destino el cluster 3 en comparación con una persona soltera sin hijos.

Un migrante que es propietario de su vivienda tiene menos probabilidad de elegir como provincia de destino a alguna de las que pertenecen al cluster 1 y 3, mientras que este efecto es contario para las provincias que pertenecen al cluster 2, en donde la probabilidad de ser un migrante que elije como cluster de destino este mismo aumenta en el caso de ser propietario de la vivienda.

Para finalizar el análisis de los factores de atracción de los migrantes hacia los cluster de destino, se tiene en cuenta el efecto de la educación del migrante en la probabildiad de elegir alguno de los tres cluster, un migrante con nivel educativo medio (secundaria completa) tiene mayor probabilidad de haber elegido al cluster 2 como su cluster de destino en relación a un migrante con un nivel educativo bajo (en adelante grupo base), sin embargo, para el cluster 3 esta probabilidad es inversa, en donde un migrante con nivel educativo medio tiene una menor probabilidad de elegir como destino a alguna de las provincias que componen este cluster en relación al grupo base. Un migrante con un nivel educativo alto tiene mayor probabilidad de elegir como destino el cluster 1 u 2 en relación al grupo base, y esta  probabilidad se reduce si se considera como destino el cluster 3, en el cual un migrante con un nivel educativo alto tiene menor probabilidad de elegir como destino alguna de las provincias que componen el cluster 3 en relación al grupo base.




